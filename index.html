<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <title>TOTP Token Generator</title>
    <style>
      :root {
        --primary-color: #007fff;
        --bg-color: #ffffff;
        --fg-color: #333333;
        --border-color: #d3d3d3;
        --select-bg-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjMzMzMzMzIiBkPSJNNy40MSA4LjU4TDEyIDEzLjE3bDQuNTktNC41OUwxOCAxMGwtNiA2bC02LTZ6Ii8+PC9zdmc+);
        --button-copy-link-bg-color: #f1f1f1;
        --button-copy-link-bg-color-hover: #e6e6e6;
        --button-copy-link-bg-color-active: #d9d9d9;
        --button-copy-token-bg-color-hover: #198cff;
        --button-copy-token-bg-color-active: #3399ff;
        --button-copy-token-fg-color: #ffffff;
        --outline-color: #007fff66;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --primary-color: #0066cc;
          --bg-color: #181818;
          --fg-color: #d3d3d3;
          --border-color: #333333;
          --select-bg-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjZDNkM2QzIiBkPSJNNy40MSA4LjU4TDEyIDEzLjE3bDQuNTktNC41OUwxOCAxMGwtNiA2bC02LTZ6Ii8+PC9zdmc+);
          --button-copy-link-bg-color: #333333;
          --button-copy-link-bg-color-hover: #404040;
          --button-copy-link-bg-color-active: #4d4d4d;
          --button-copy-token-bg-color-hover: #0059b3;
          --button-copy-token-bg-color-active: #004d99;
          --button-copy-token-fg-color: #e6e6e6;
          --outline-color: #0066cc66;
        }
      }

      * {
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
        text-size-adjust: 100%;
        -moz-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
        -webkit-text-size-adjust: 100%;
      }

      body {
        background-color: var(--bg-color);
        color: var(--fg-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans",
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        font-size: 16px;
        font-weight: 400;
        line-height: 1.5;
        margin: 0;
      }

      main {
        align-items: center;
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-left: auto;
        margin-right: auto;
        max-width: 416px;
        padding: 72px 24px;
      }

      h1 {
        font-size: 28px;
        font-weight: 600;
        margin: 0;
      }

      form {
        display: grid;
        gap: 12px 16px;
        grid-template-columns: 1.5fr 1fr 1fr;
        margin-top: 24px;
        width: 100%;
      }

      label {
        display: block;
        margin-bottom: 4px;
      }

      input {
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: inherit;
        display: block;
        font-family: inherit;
        font-size: inherit;
        font-weight: inherit;
        line-height: inherit;
        outline: 2px solid transparent;
        outline-offset: 0;
        padding: 8px 12px;
        transition: all 233ms ease;
        width: 100%;
      }

      select {
        appearance: none;
        background-color: var(--bg-color);
        background-image: var(--select-bg-image);
        background-position: right 6px center;
        background-repeat: no-repeat;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: inherit;
        cursor: pointer;
        display: block;
        font-family: inherit;
        font-size: inherit;
        font-weight: inherit;
        line-height: inherit;
        outline: 2px solid transparent;
        outline-offset: 0;
        padding: 8px 36px 8px 12px;
        transition: all 233ms ease;
        width: 100%;
        -moz-appearance: none;
        -webkit-appearance: none;
      }

      input:hover,
      select:hover {
        border-color: var(--primary-color);
      }

      input:focus,
      select:focus {
        border-color: var(--primary-color);
        outline-color: var(--outline-color);
      }

      input:focus:not(:focus-visible),
      select:focus:not(:focus-visible) {
        outline-color: transparent;
      }

      input:focus-visible,
      select:focus-visible {
        outline-color: var(--outline-color);
      }

      .token-wrapper {
        border: 2px dashed var(--border-color);
        border-radius: 4px;
        padding: 16px;
        position: relative;
        width: 100%;
      }

      #token {
        color: var(--primary-color);
        font-size: 64px;
        font-weight: bold;
        letter-spacing: 4px;
        line-height: 1;
        text-align: center;
        word-break: break-all;
      }

      #countdown {
        font-size: 14px;
        position: absolute;
        right: 4px;
        top: 0;
      }

      .button {
        background-color: transparent;
        border: none;
        border-radius: 50%;
        color: inherit;
        cursor: pointer;
        display: flex;
        font-size: inherit;
        margin: 0;
        outline: 2px solid transparent;
        outline-offset: 0;
        padding: 0;
        transition: all 233ms ease;
      }

      .button:focus {
        outline-color: var(--outline-color);
      }

      .button:focus:not(:focus-visible) {
        outline-color: transparent;
      }

      .button:focus-visible {
        outline-color: var(--outline-color);
      }

      .button-copy-token {
        background-color: var(--primary-color);
        color: var(--button-copy-token-fg-color);
        padding: 12px;
      }

      .button-copy-token:hover {
        background-color: var(--button-copy-token-bg-color-hover);
      }

      .button-copy-token:active {
        background-color: var(--button-copy-token-bg-color-active);
      }

      .button-copy-link {
        background-color: var(--button-copy-link-bg-color);
        color: var(--primary-color);
        font-size: 20px;
        padding: 8px;
        position: fixed;
        right: 12px;
        top: 12px;
      }

      .button-copy-link:hover {
        background-color: var(--button-copy-link-bg-color-hover);
      }

      .button-copy-link:active {
        background-color: var(--button-copy-link-bg-color-active);
      }

      .tippy-box {
        --tippy-bg-color: var(--fg-color);
        --tippy-fg-color: var(--bg-color);
        background-color: var(--tippy-bg-color);
        color: var(--tippy-fg-color);
        line-height: inherit;
      }

      .tippy-content {
        padding: 4px 8px;
      }
    </style>
  </head>
  <body>
    <main>
      <img alt="TOTP" height="64" loading="lazy" src="/favicon.svg" />
      <h1>TOTP Token Generator</h1>
      <form id="form">
        <div style="grid-column: span 3">
          <label for="secret">Secret</label>
          <input
            id="secret"
            name="secret"
            required
            type="text"
            value="TVOMAYCNJLSYURIF"
          />
        </div>
        <div>
          <label for="algorithm">Algorithm</label>
          <select id="algorithm" name="algorithm" required>
            <option value="SHA1">SHA1</option>
            <option value="SHA224">SHA224</option>
            <option value="SHA256">SHA256</option>
            <option value="SHA384">SHA384</option>
            <option value="SHA512">SHA512</option>
            <option value="SHA3-224">SHA3-224</option>
            <option value="SHA3-256">SHA3-256</option>
            <option value="SHA3-384">SHA3-384</option>
            <option value="SHA3-512">SHA3-512</option>
          </select>
        </div>
        <div>
          <label for="digits">Digits</label>
          <input
            id="digits"
            inputmode="numeric"
            maxlength="2"
            name="digits"
            required
            type="text"
            value="6"
          />
        </div>
        <div>
          <label for="period">Period</label>
          <input
            id="period"
            inputmode="numeric"
            maxlength="3"
            name="period"
            required
            type="text"
            value="30"
          />
        </div>
      </form>
      <div class="token-wrapper">
        <div id="token">-</div>
        <div id="countdown">-s</div>
      </div>
      <button class="button button-copy-token" id="copy-token">
        <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12z"
            fill="currentColor"
          />
        </svg>
      </button>
      <button class="button button-copy-link" id="copy-link">
        <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5a5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5a5 5 0 0 0-5-5"
            fill="currentColor"
          />
        </svg>
      </button>
    </main>
    <script src="/otpauth.umd.min.js"></script>
    <script src="/popper.min.js"></script>
    <script src="/tippy-bundle.umd.min.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const defaultParams = {
        secret: "TVOMAYCNJLSYURIF",
        algorithm: "SHA1",
        digits: "6",
        period: "30",
      };

      Object.entries(defaultParams).forEach(([key, value]) => {
        if (params.has(key) && params.get(key) !== value) {
          document.forms["form"][key].value = params.get(key);
        }
      });

      const form = document.getElementById("form");
      form.addEventListener("input", (e) => {
        const url = new URL(window.location.href);

        if (e.target.value === defaultParams[e.target.name]) {
          url.searchParams.delete(e.target.name);
        } else {
          url.searchParams.set(e.target.name, e.target.value);
        }

        window.history.replaceState(null, "", url);

        checkParams();
      });

      const tokenElement = document.getElementById("token");
      const countdownElement = document.getElementById("countdown");

      const checkParams = () => {
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }

        const values = Object.fromEntries(new FormData(form));

        if (
          values.secret &&
          values.algorithm &&
          /^[1-9]\d*$/.test(values.digits) &&
          /^[1-9]\d*$/.test(values.period)
        ) {
          try {
            const totp = new OTPAuth.TOTP(values);
            generateToken(totp);
          } catch (error) {
            tokenElement.textContent = "-";
            countdownElement.textContent = "-s";
          }
        } else {
          tokenElement.textContent = "-";
          countdownElement.textContent = "-s";
        }
      };

      let timeoutId;

      const generateToken = (totp) => {
        const token = totp.generate();
        if (tokenElement.innerText !== token) {
          tokenElement.innerText = token;
        }

        const period = totp.period;
        const seconds = period - (Math.floor(Date.now() / 1000) % period);
        countdownElement.innerText = `${seconds}s`;

        timeoutId = setTimeout(() => generateToken(totp), 1000);
      };

      checkParams();

      const setupCopyButton = (elementId, message, copyAction) => {
        const copyElement = document.getElementById(elementId);

        const copyTippy = tippy(copyElement, {
          arrow: false,
          hideOnClick: false,
          placement: "bottom",
          onHide: (instance) => {
            if (copyTimeoutId) {
              clearTimeout(copyTimeoutId);
              copyTimeoutId = null;
            }
          },
          onShow: (instance) => {
            instance.setContent(message);
          },
        });

        let copyTimeoutId;

        copyElement.addEventListener("click", () => {
          if (copyTimeoutId) {
            clearTimeout(copyTimeoutId);
            copyTimeoutId = null;
          }

          const valueToCopy = copyAction();
          if (valueToCopy) {
            copyToClipboard(valueToCopy);
            copyTippy.setContent("Copied!");
            copyTimeoutId = setTimeout(() => {
              copyTippy.setContent(message);
            }, 2333);
          }
        });
      };

      setupCopyButton("copy-token", "Copy token to clipboard", () => {
        const token = tokenElement.innerText;
        return token === "-" ? null : token;
      });
      setupCopyButton("copy-link", "Copy link to clipboard", () => {
        return window.location.href;
      });

      const copyToClipboard = (data) => {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(data);
        } else {
          const fakeElement = document.createElement("textarea");
          fakeElement.style.border = "0";
          fakeElement.style.fontSize = "12pt";
          fakeElement.style.margin = "0";
          fakeElement.style.padding = "0";
          fakeElement.style.position = "absolute";

          const isRTL = document.documentElement.getAttribute("dir") === "rtl";
          fakeElement.style[isRTL ? "right" : "left"] = "-9999px";
          const yPosition =
            window.pageYOffset || document.documentElement.scrollTop;
          fakeElement.style.top = `${yPosition}px`;

          fakeElement.setAttribute("readonly", "");
          fakeElement.value = data;

          document.body.appendChild(fakeElement);

          fakeElement.select();
          fakeElement.setSelectionRange(0, fakeElement.value.length);

          document.execCommand("copy");

          fakeElement.remove();
        }
      };
    </script>
  </body>
</html>
